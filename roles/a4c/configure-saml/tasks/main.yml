- name: Create temporary folder
  become_user: "{{ a4c_user }}"
  tempfile:
    state: directory
    suffix: saml_a4c
  register: temp_dir

- name: Extract SAML config archive
  unarchive:
    src: "{{ inventory_dir }}/{{ saml_config_archive_path }}"
    dest: "{{ temp_dir.path }}"
    remote_src: no

- name: Recursively find /tmp files older than 4 weeks and equal or greater than 1 megabyte
  find:
    paths: "{{ temp_dir.path }}"
    patterns: 'idp-metadata.xml'
    recurse: yes
  register: idp_find_result

- debug:
    var: idp_find_result

- name: Fail when not exactly 1 idp-metadata.xml found
  fail:
    msg: "I expect to have one and only one idp-metadata.xml file, got {{ idp_find_result.matched }} !"
  when: (idp_find_result.matched != 1)

- name: Copy idp-metadata.xml into A4C config directory
  copy:
    src: "{{ idp_find_result.files[0].path }}"
    dest: "{{ a4c_install_dir }}/alien4cloud/config/"
    remote_src: yes
